<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live TV Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.7/shaka-player.compiled.js"></script>
  <style>
    body { margin:0; background:#000; display:flex; justify-content:center; align-items:center; height:100vh; }
    #video { width:100%; max-width:960px; height:540px; background:#000; }
  </style>
</head>
<body>
  <video id="video" controls autoplay></video>

  <script>
    // Get channel ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const channelId = urlParams.get('id');

    async function fetchChannelData(id) {
      const res = await fetch(`/api/channel/${id}`);
      if (!res.ok) throw new Error("Channel not found");
      return await res.json();
    }

    async function initPlayer() {
      try {
        const ch = await fetchChannelData(channelId);
        const video = document.getElementById('video');

        // Initialize Shaka Player
        const player = new shaka.Player(video);

        // Attach error handler
        player.addEventListener('error', e => console.error('Shaka error', e));

        const config = {};

        // If DRM is set
        if (ch.drmScheme && ch.drmLicense) {
          config.drm = {
            servers: {
              [ch.drmScheme]: ch.drmLicense
            },
            advanced: {
              [ch.drmScheme]: {
                'serverCertificate': null
              }
            }
          };
        }

        // If cookie is set, use license request headers
        if (ch.cookie) {
          config.drm = config.drm || {};
          config.drm.advanced = config.drm.advanced || {};
          config.drm.advanced[ch.drmScheme || 'com.widevine.alpha'] = {
            headers: {
              'Cookie': ch.cookie
            }
          };
        }

        player.configure(config);

        // Load the video
        await player.load(ch.link);
        console.log('Video loaded:', ch.name);
      } catch (err) {
        console.error(err);
        document.body.innerHTML = `<p style="color:white;text-align:center;">‚ùå Failed to load video: ${err.message}</p>`;
      }
    }

    initPlayer();
  </script>
</body>
</html>
