<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Player</title>
    <script src="https://cdn.jsdelivr.net/npm/shaka-player@4.7.0/dist/shaka-player.compiled.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        #header {
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            padding: 15px 20px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: opacity 0.3s, transform 0.3s;
        }

        #header.hidden {
            opacity: 0;
            transform: translateY(-100%);
            pointer-events: none;
        }

        #channel-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #channel-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            padding: 5px;
        }

        #channel-details h1 {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        #channel-details p {
            font-size: 14px;
            color: #888;
        }

        #video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
            position: relative;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        #loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(255,0,0,0.9);
            padding: 25px 40px;
            border-radius: 12px;
            max-width: 90%;
            z-index: 20;
            display: none;
        }

        #error.visible {
            display: block;
        }

        #error h2 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        #error p {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 15px;
        }

        #error button {
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        #controls {
            background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            padding: 20px;
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            transition: opacity 0.3s, transform 0.3s;
        }

        #controls.hidden {
            opacity: 0;
            transform: translateY(100%);
            pointer-events: none;
        }

        #progress-container {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-bottom: 15px;
            cursor: pointer;
            position: relative;
        }

        #progress-bar {
            height: 100%;
            background: #ff0000;
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }

        #control-buttons {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        button:hover {
            background: rgba(255,255,255,0.2);
        }

        button:active {
            background: rgba(255,255,255,0.3);
        }

        #play-pause {
            font-size: 24px;
            padding: 10px 20px;
        }

        #time-display {
            font-size: 14px;
            color: #ddd;
            min-width: 100px;
        }

        #quality-selector {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        #quality-selector option {
            background: #222;
            color: #fff;
        }

        .live-badge {
            background: #ff0000;
            color: #fff;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        #debug-info {
            position: absolute;
            top: 80px;
            right: 10px;
            background: rgba(0,0,0,0.95);
            padding: 12px 15px;
            font-size: 11px;
            border-radius: 8px;
            max-width: 400px;
            word-wrap: break-word;
            z-index: 50;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.1);
        }

        #debug-info::-webkit-scrollbar {
            width: 6px;
        }

        #debug-info::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        #debug-info::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .debug-line {
            margin: 3px 0;
            padding: 2px 0;
        }

        .debug-success {
            color: #00ff00;
        }

        .debug-error {
            color: #ff4444;
            font-weight: bold;
        }

        .debug-info {
            color: #00d4ff;
        }

        .debug-warning {
            color: #ffaa00;
        }

        .debug-header {
            color: #fff;
            font-weight: bold;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 5px;
            margin-bottom: 5px;
        }

        /* Mobile adjustments */
        @media (max-width: 768px) {
            #header {
                padding: 10px 15px;
            }

            #channel-logo {
                width: 40px;
                height: 40px;
            }

            #channel-details h1 {
                font-size: 16px;
            }

            #channel-details p {
                font-size: 12px;
            }

            #controls {
                padding: 15px;
            }

            #control-buttons {
                flex-wrap: wrap;
            }

            .btn-group {
                flex: 1;
                justify-content: center;
            }

            button {
                padding: 8px 12px;
                font-size: 12px;
            }

            #play-pause {
                font-size: 20px;
                padding: 8px 16px;
            }

            #debug-info {
                font-size: 9px;
                max-width: 250px;
                max-height: 250px;
                top: 60px;
                right: 5px;
                padding: 8px 10px;
            }
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Header with channel info -->
        <div id="header">
            <div id="channel-info">
                <img id="channel-logo" 
                     src="" 
                     alt="Logo" 
                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2250%22 height=%2250%22%3E%3Crect fill=%22%23333%22 width=%2250%22 height=%2250%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23fff%22 font-size=%2220%22%3ETV%3C/text%3E%3C/svg%3E'">
                <div id="channel-details">
                    <h1 id="channel-name">Loading...</h1>
                    <p><span class="live-badge">🔴 LIVE</span></p>
                </div>
            </div>
        </div>

        <!-- Video container -->
        <div id="video-container">
            <video id="video" playsinline></video>
            
            <!-- Loading spinner -->
            <div id="loading">
                <div class="spinner"></div>
                <p>Loading stream...</p>
            </div>

            <!-- Error message -->
            <div id="error">
                <h2>⚠️ Playback Error</h2>
                <p id="error-message">Unable to load the stream</p>
                <button onclick="location.reload()">🔄 Retry</button>
            </div>
        </div>

        <!-- Player controls -->
        <div id="controls">
            <div id="progress-container">
                <div id="progress-bar"></div>
            </div>
            <div id="control-buttons">
                <div class="btn-group">
                    <button id="play-pause">▶️</button>
                    <span id="time-display">LIVE</span>
                </div>
                <div class="btn-group">
                    <button id="mute-btn">🔊</button>
                    <select id="quality-selector">
                        <option value="auto">Auto</option>
                    </select>
                    <button id="fullscreen-btn">⛶</button>
                </div>
            </div>
        </div>

        <!-- Debug panel -->
        <div id="debug-info"></div>
    </div>

    <script>
        // Get channel ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const channelId = urlParams.get('id');

        // DOM elements
        const video = document.getElementById('video');
        const loading = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        const header = document.getElementById('header');
        const controls = document.getElementById('controls');
        const playPauseBtn = document.getElementById('play-pause');
        const muteBtn = document.getElementById('mute-btn');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const qualitySelector = document.getElementById('quality-selector');
        const debugInfo = document.getElementById('debug-info');

        // Global variables
        let player;
        let hideControlsTimeout;
        let channelData;

        // Debug logging with colors
        function debug(msg, type = 'info') {
            console.log('[Player]', msg);
            const line = document.createElement('div');
            line.className = `debug-line debug-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${msg}`;
            debugInfo.appendChild(line);
            debugInfo.scrollTop = debugInfo.scrollHeight;
        }

        // Hex to Base64 conversion for ClearKey DRM
        function hexToBase64(hexString) {
            const hex = hexString.replace(/\s/g, '');
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return btoa(String.fromCharCode.apply(null, bytes));
        }

        // Custom network request filter to inject cookies
        class CookieRequestFilter {
            constructor(cookie) {
                this.cookie = cookie;
            }

            request(type, request) {
                // Add cookie to all network requests
                if (this.cookie) {
                    request.headers['Cookie'] = this.cookie;
                }
                
                // Add required headers for JioCinema CDN
                request.headers['User-Agent'] = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36';
                request.headers['Origin'] = 'https://www.jiocinema.com';
                request.headers['Referer'] = 'https://www.jiocinema.com/';
                request.headers['Accept'] = '*/*';
            }
        }

        // Fetch channel data from API
        async function loadChannel() {
            try {
                debug('=== PLAYER INITIALIZING ===', 'header');
                debug(`Fetching channel data: ${channelId}`, 'info');
                
                const response = await fetch(`/api/channel/${channelId}`);
                
                if (!response.ok) {
                    throw new Error(`Channel not found (HTTP ${response.status})`);
                }
                
                channelData = await response.json();
                
                debug(`✓ Channel loaded: ${channelData.name}`, 'success');
                debug(`Category: ${channelData.category}`, 'info');
                debug(`DRM Scheme: ${channelData.drmScheme || 'None'}`, 'info');
                
                if (channelData.cookie) {
                    const cookiePreview = channelData.cookie.substring(0, 50);
                    debug(`✓ Cookie present: ${cookiePreview}...`, 'success');
                } else {
                    debug(`✗ No cookie found!`, 'warning');
                }
                
                debug(`Manifest URL: ${channelData.link}`, 'info');
                
                // Update UI
                document.getElementById('channel-name').textContent = channelData.name;
                document.getElementById('channel-logo').src = channelData.logo || '';
                document.title = `${channelData.name} - Live TV`;
                
                // Initialize player
                await initPlayer();
                
            } catch (err) {
                debug(`✗✗✗ ERROR loading channel: ${err.message}`, 'error');
                showError('Failed to load channel: ' + err.message);
            }
        }

        // Initialize Shaka Player
        async function initPlayer() {
            try {
                debug('--- SHAKA PLAYER SETUP ---', 'header');
                debug('Checking browser support...', 'info');
                
                if (!shaka.Player.isBrowserSupported()) {
                    throw new Error('Browser not supported for DASH playback');
                }
                debug('✓ Browser is supported', 'success');

                debug('Creating Shaka Player instance...', 'info');
                player = new shaka.Player(video);
                debug('✓ Player instance created', 'success');

                // Register network filter for cookies
                debug('Registering cookie filter...', 'info');
                const cookieFilter = new CookieRequestFilter(channelData.cookie);
                player.getNetworkingEngine().registerRequestFilter(
                    cookieFilter.request.bind(cookieFilter)
                );
                debug('✓ Cookie filter registered (will inject into all requests)', 'success');

                // Configure player with optimized settings
                debug('Configuring player settings...', 'info');
                player.configure({
                    streaming: {
                        bufferingGoal: 30,
                        rebufferingGoal: 5,
                        bufferBehind: 30,
                        retryParameters: {
                            maxAttempts: 5,
                            baseDelay: 1000,
                            backoffFactor: 2,
                            fuzzFactor: 0.5,
                            timeout: 30000
                        }
                    },
                    manifest: {
                        retryParameters: {
                            maxAttempts: 5,
                            baseDelay: 1000,
                            backoffFactor: 2,
                            timeout: 30000
                        }
                    }
                });
                debug('✓ Player configured', 'success');

                // Setup DRM if needed
                if (channelData.drmScheme && channelData.drmLicense) {
                    debug('--- DRM SETUP ---', 'header');
                    setupDRM();
                }

                // Error handling
                player.addEventListener('error', onPlayerError);

                // Load manifest (DIRECT URL from API - no proxy)
                const manifestUrl = channelData.link;
                debug('--- LOADING MANIFEST ---', 'header');
                debug(`URL: ${manifestUrl}`, 'info');
                debug('Loading manifest...', 'info');

                await player.load(manifestUrl);
                
                debug('✓✓✓ Manifest loaded successfully!', 'success');
                
                // Setup quality selector
                setupQualitySelector();

                // Hide loading spinner
                loading.classList.add('hidden');
                
                // Start playback
                debug('--- STARTING PLAYBACK ---', 'header');
                debug('Attempting to play video...', 'info');
                
                await video.play();
                playPauseBtn.textContent = '⏸️';

                debug('✓✓✓ PLAYBACK STARTED SUCCESSFULLY!', 'success');
                debug('=== PLAYER READY ===', 'header');
                
                // Hide debug panel after 10 seconds
                setTimeout(() => {
                    debugInfo.style.display = 'none';
                }, 10000);

            } catch (err) {
                debug('--- CRITICAL ERROR ---', 'header');
                debug(`✗✗✗ Player initialization failed: ${err.message}`, 'error');
                
                if (err.code) {
                    debug(`Error code: ${err.code}`, 'error');
                }
                
                if (err.data) {
                    debug(`Error details: ${JSON.stringify(err.data)}`, 'error');
                }
                
                showError('Playback failed: ' + err.message);
                console.error('Full error:', err);
            }
        }

        // Setup DRM (ClearKey)
        function setupDRM() {
            if (channelData.drmScheme.toLowerCase() === 'clearkey') {
                debug('DRM Type: ClearKey', 'info');
                
                // Parse license format: "keyHex:kidHex"
                const parts = channelData.drmLicense.split(':');
                
                if (parts.length !== 2) {
                    debug('✗ Invalid ClearKey format (expected key:kid)', 'error');
                    return;
                }

                const [keyHex, kidHex] = parts;
                debug(`Key (hex): ${keyHex.substring(0, 16)}...`, 'info');
                debug(`KID (hex): ${kidHex.substring(0, 16)}...`, 'info');

                try {
                    // Convert hex to base64
                    const keyBase64 = hexToBase64(keyHex);
                    const kidBase64 = hexToBase64(kidHex);
                    
                    debug(`Key (base64): ${keyBase64.substring(0, 16)}...`, 'info');
                    debug(`KID (base64): ${kidBase64.substring(0, 16)}...`, 'info');

                    // Configure ClearKey DRM
                    player.configure({
                        drm: {
                            clearKeys: {
                                [kidBase64]: keyBase64
                            }
                        }
                    });

                    debug('✓ ClearKey DRM configured successfully', 'success');
                    
                } catch (e) {
                    debug(`✗ ClearKey setup error: ${e.message}`, 'error');
                }
            } else {
                debug(`Unsupported DRM: ${channelData.drmScheme}`, 'warning');
            }
        }

        // Setup quality selector
        function setupQualitySelector() {
            const tracks = player.getVariantTracks();
            debug(`Found ${tracks.length} quality tracks`, 'info');
            
            qualitySelector.innerHTML = '<option value="auto">Auto</option>';
            
            // Get unique quality heights
            const qualities = new Set();
            tracks.forEach(track => {
                if (track.height) {
                    qualities.add(track.height);
                }
            });
            
            // Add quality options
            Array.from(qualities).sort((a, b) => b - a).forEach(height => {
                const option = document.createElement('option');
                option.value = height;
                option.textContent = `${height}p`;
                qualitySelector.appendChild(option);
                debug(`Quality available: ${height}p`, 'info');
            });
            
            // Quality change handler
            qualitySelector.addEventListener('change', (e) => {
                if (e.target.value === 'auto') {
                    player.configure({abr: {enabled: true}});
                    debug('✓ Auto quality enabled', 'success');
                } else {
                    player.configure({abr: {enabled: false}});
                    const targetHeight = parseInt(e.target.value);
                    const track = tracks.find(t => t.height === targetHeight);
                    if (track) {
                        player.selectVariantTrack(track);
                        debug(`✓ Quality changed to ${targetHeight}p`, 'success');
                    }
                }
            });
        }

        // Show error message
        function showError(message) {
            loading.classList.add('hidden');
            errorMessage.textContent = message;
            errorDiv.classList.add('visible');
        }

        // Player error handler
        function onPlayerError(event) {
            const error = event.detail;
            console.error('Shaka Player Error:', error);
            
            debug('--- PLAYBACK ERROR ---', 'header');
            debug(`✗ Error code: ${error.code}`, 'error');
            debug(`✗ Message: ${error.message}`, 'error');
            
            if (error.data) {
                debug(`✗ Additional data: ${JSON.stringify(error.data)}`, 'error');
            }
            
            showError(error.message || 'Playback error occurred');
        }

        // ===== PLAYER CONTROLS =====

        // Play/Pause button
        playPauseBtn.addEventListener('click', () => {
            if (video.paused) {
                video.play();
                playPauseBtn.textContent = '⏸️';
                debug('▶ Resumed playback', 'info');
            } else {
                video.pause();
                playPauseBtn.textContent = '▶️';
                debug('⏸ Paused playback', 'info');
            }
        });

        // Mute button
        muteBtn.addEventListener('click', () => {
            video.muted = !video.muted;
            muteBtn.textContent = video.muted ? '🔇' : '🔊';
            debug(video.muted ? '🔇 Muted' : '🔊 Unmuted', 'info');
        });

        // Fullscreen button
        fullscreenBtn.addEventListener('click', () => {
            if (!document.fullscreenElement) {
                document.getElementById('container').requestFullscreen().catch(err => {
                    debug(`✗ Fullscreen error: ${err.message}`, 'error');
                });
            } else {
                document.exitFullscreen();
            }
        });

        // ===== AUTO-HIDE CONTROLS =====

        function resetHideControlsTimer() {
            clearTimeout(hideControlsTimeout);
            header.classList.remove('hidden');
            controls.classList.remove('hidden');
            
            hideControlsTimeout = setTimeout(() => {
                if (!video.paused) {
                    header.classList.add('hidden');
                    controls.classList.add('hidden');
                }
            }, 3000);
        }

        document.getElementById('container').addEventListener('mousemove', resetHideControlsTimer);
        document.getElementById('container').addEventListener('touchstart', resetHideControlsTimer);
        document.getElementById('container').addEventListener('click', resetHideControlsTimer);

        // ===== VIDEO EVENT LISTENERS =====

        video.addEventListener('playing', () => {
            debug('▶ Video is playing', 'success');
        });

        video.addEventListener('waiting', () => {
            debug('⏳ Buffering...', 'warning');
        });

        video.addEventListener('pause', () => {
            debug('⏸ Video paused', 'info');
        });

        video.addEventListener('error', (e) => {
            debug(`✗ Video element error: ${e.message}`, 'error');
        });

        video.addEventListener('loadedmetadata', () => {
            debug('✓ Video metadata loaded', 'success');
        });

        // ===== START PLAYER =====

        if (channelId) {
            loadChannel();
        } else {
            debug('✗✗✗ No channel ID provided in URL', 'error');
            showError('No channel ID provided');
        }

        // ===== CLEANUP =====

        window.addEventListener('beforeunload', () => {
            if (player) {
                debug('Destroying player...', 'info');
                player.destroy();
            }
        });

        // Toggle debug panel on double-click
        document.getElementById('container').addEventListener('dblclick', (e) => {
            if (e.target === video || e.target === document.getElementById('video-container')) {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
            }
        });
    </script>
</body>
</html>        #channel
