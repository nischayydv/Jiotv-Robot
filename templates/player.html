<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live TV Player</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.7/shaka-player.compiled.js"></script>
  <style>
    body { margin:0; background:#000; display:flex; justify-content:center; align-items:center; height:100vh; }
    #video { width:100%; max-width:960px; height:540px; background:#000; }
  </style>
</head>
<body>
  <video id="video" controls autoplay></video>

  <script>
    // Get channel ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const channelId = urlParams.get('id');

    async function fetchChannelData(id) {
      const res = await fetch(`/api/channel/${id}`);
      if (!res.ok) throw new Error("Channel not found");
      return await res.json();
    }

    async function initPlayer() {
      try {
        const ch = await fetchChannelData(channelId);
        if (!ch.link) throw new Error("Channel link missing");

        const video = document.getElementById('video');
        const player = new shaka.Player(video);

        // Log Shaka errors
        player.addEventListener('error', e => {
          console.error('Shaka Player Error:', e.detail);
          alert('Shaka Player Error: ' + e.detail?.message || 'Unknown error');
        });

        // Configure Clearkey DRM if present
        if (ch.drmScheme && ch.drmLicense) {
          player.configure({
            drm: {
              servers: { [ch.drmScheme]: ch.drmLicense },
              advanced: {
                [ch.drmScheme]: {
                  headers: ch.cookie ? { 'Cookie': ch.cookie } : {}
                }
              }
            }
          });
        }

        console.log("Loading video:", ch.link);
        await player.load(ch.link);  // Load the DASH stream
        console.log("✅ Video loaded:", ch.name);

      } catch (err) {
        console.error("Player init error:", err);
        document.body.innerHTML = `<p style="color:white;text-align:center;">❌ Failed to load video: ${err.message}</p>`;
      }
    }

    // Initialize player
    initPlayer();
  </script>
</body>
</html>
